from groq import Groq
import os
from dotenv import load_dotenv
from flask import Flask, render_template, request, jsonify
from datetime import datetime

load_dotenv()

app = Flask(__name__)

class PizzariaAssistente:
    def __init__(self):
        self.client = Groq(api_key=os.getenv("GROQ_API_KEY"))
        self.pedido_atual = {
            "itens": None,
            "endereco": None,
            "total": 0
        }
        self.cardapio = """
üçï CARD√ÅPIO DE PIZZAS:
Tradicionais (R$ 45,90):
- Margherita: Molho de tomate, mussarela, manjeric√£o fresco
- Calabresa: Molho de tomate, calabresa, cebola
- Portuguesa: Molho de tomate, presunto, ovo, cebola, azeitona

Especiais (R$ 52,90):
- Quatro Queijos: Mussarela, provolone, parmes√£o, gorgonzola
- Frango com Catupiry: Frango desfiado, catupiry, milho
- Pepperoni: Molho de tomate, pepperoni, mussarela

ü•§ BEBIDAS:
- Refrigerante 2L: R$ 12,90
- Refrigerante Lata: R$ 6,90
- Suco Natural: R$ 8,90
- √Ågua Mineral: R$ 4,90

üç´ SOBREMESAS (Pizza Doce):
- Chocolate com Morango: R$ 39,90
- Banana com Canela: R$ 37,90
- Doce de Leite com Coco: R$ 39,90

‚ÑπÔ∏è Informa√ß√µes:
- Taxa de entrega: R$ 5,00
- Tempo m√©dio de entrega: 45 minutos"""

    def processar_mensagem(self, mensagem_cliente):
        try:
            if not self.pedido_atual["itens"]:
                # Primeira mensagem: Verifica se √© delivery ou retirada
                if "retirada" in mensagem_cliente.lower():
                    completion = self.client.chat.completions.create(
                        model="llama-3.3-70b-versatile",
                        messages=[
                            {
                                "role": "system",
                                "content": """Confirme o pedido para retirada:
                                1. Confirme os itens e valor total
                                2. Informe que estar√° pronto em 30 minutos
                                3. Agrade√ßa o pedido
                                4. Seja conciso"""
                            },
                            {
                                "role": "user",
                                "content": mensagem_cliente
                            }
                        ],
                        temperature=0.7,
                        max_completion_tokens=1024,
                        stream=True
                    )
                    # Reseta o pedido ap√≥s finalizar
                    self.pedido_atual = {"itens": None, "endereco": None, "total": 0}
                else:
                    # Se n√£o for retirada, assume delivery e pede endere√ßo
                    completion = self.client.chat.completions.create(
                        model="llama-3.3-70b-versatile",
                        messages=[
                            {
                                "role": "system",
                                "content": """Confirme o pedido e pe√ßa o endere√ßo:
                                1. Confirme os itens e valores
                                2. Pe√ßa o endere√ßo de entrega
                                3. Seja conciso"""
                            },
                            {
                                "role": "user",
                                "content": mensagem_cliente
                            }
                        ],
                        temperature=0.7,
                        max_completion_tokens=1024,
                        stream=True
                    )
                    self.pedido_atual["itens"] = mensagem_cliente
            
            elif not self.pedido_atual["endereco"]:
                # Segunda mensagem: Apenas para delivery - finaliza com endere√ßo
                self.pedido_atual["endereco"] = mensagem_cliente
                completion = self.client.chat.completions.create(
                    model="llama-3.3-70b-versatile",
                    messages=[
                        {
                            "role": "system",
                            "content": """Finalize o pedido:
                            1. Confirme o endere√ßo
                            2. Informe taxa de entrega (R$ 5,00) e valor total
                            3. Informe tempo de entrega (45 minutos)
                            4. Agrade√ßa o pedido
                            5. Seja conciso"""
                        },
                        {
                            "role": "user",
                            "content": f"Endere√ßo: {mensagem_cliente}"
                        }
                    ],
                    temperature=0.7,
                    max_completion_tokens=1024,
                    stream=True
                )
                # Reseta o pedido ap√≥s finalizar
                self.pedido_atual = {"itens": None, "endereco": None, "total": 0}
            
            resposta_completa = ""
            for chunk in completion:
                pedaco_resposta = chunk.choices[0].delta.content or ""
                resposta_completa += pedaco_resposta
                print(pedaco_resposta, end="", flush=True)
            print("\n")
            return resposta_completa
            
        except Exception as e:
            return f"Desculpe, ocorreu um erro: {str(e)}"

    def iniciar_atendimento(self):
        print("\n=== üçï Bem-vindo √† Pizzaria Virtual! üçï ===")
        print("Digite 'cardapio' para ver as op√ß√µes")
        print("Digite 'finalizar' para concluir seu pedido")
        print("Digite 'sair' para encerrar o atendimento\n")
        
        nome_cliente = input("Por favor, digite seu nome: ")
        print(f"\nOl√° {nome_cliente}! Como posso ajudar voc√™ hoje? üòä")
        
        while True:
            mensagem = input("\nVoc√™: ")
            
            if mensagem.lower() == 'sair':
                print("\nObrigado pela prefer√™ncia! Volte sempre! üëã")
                break
                
            if mensagem.lower() == 'cardapio':
                print(self.cardapio)
                continue
                
            print("\nAtendente:", end=" ")
            self.processar_mensagem(mensagem)

assistente = PizzariaAssistente()

@app.route('/')
def home():
    return render_template('index.html', cardapio=assistente.cardapio)

@app.route('/enviar_mensagem', methods=['POST'])
def enviar_mensagem():
    mensagem = request.json['mensagem']
    resposta = assistente.processar_mensagem(mensagem)
    return jsonify({'resposta': resposta})

if __name__ == '__main__':
    app.run(debug=True)
